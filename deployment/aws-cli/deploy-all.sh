#!/bin/bash
# deploy-all.sh
# ä¸€é”®éƒ¨ç½²æ•´ä¸ª Kortix åç«¯åˆ° AWS EKS

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

# è‰ºæœ¯å­—æ ‡é¢˜
echo -e "${PURPLE}"
cat << "EOF"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                               â•‘
â•‘   â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—              â•‘
â•‘   â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•              â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ•”â•               â•‘
â•‘   â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—               â•‘
â•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—              â•‘
â•‘   â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•   â•šâ•â•   â•šâ•â•â•šâ•â•  â•šâ•â•              â•‘
â•‘                                                               â•‘
â•‘           AWS EKS è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬                               â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
echo -e "${NC}"

echo -e "${BLUE}ğŸš€ å¼€å§‹è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹...${NC}\n"

# æ£€æŸ¥æ˜¯å¦æœ‰å¿…è¦çš„æ–‡ä»¶
REQUIRED_FILES=(
    "00-prerequisites.sh"
    "01-create-cluster.sh"
    "02-install-addons.sh" 
    "03-configure-secrets.sh"
    "04-deploy-application.sh"
    "05-setup-monitoring.sh"
)

for file in "${REQUIRED_FILES[@]}"; do
    if [ ! -f "$file" ]; then
        echo -e "${RED}âŒ æ‰¾ä¸åˆ°å¿…è¦æ–‡ä»¶: $file${NC}"
        exit 1
    fi
done

# ç¡®è®¤éƒ¨ç½²
echo -e "${YELLOW}âš ï¸  è¿™å°†åœ¨æ‚¨çš„ AWS è´¦æˆ·ä¸­åˆ›å»ºä»¥ä¸‹èµ„æº:${NC}"
echo "â€¢ EKS é›†ç¾¤ (kortix-cluster)"
echo "â€¢ EC2 å®ä¾‹ (2-5ä¸ªèŠ‚ç‚¹)"
echo "â€¢ LoadBalancers (ALB/NLB)"
echo "â€¢ EBS å· (å­˜å‚¨)"
echo "â€¢ ç›‘æ§ç³»ç»Ÿ (Prometheus/Grafana)"
echo ""
echo -e "${YELLOW}é¢„ä¼°æˆæœ¬: $100-200/æœˆ${NC}"
echo ""
read -p "ç¡®è®¤ç»§ç»­éƒ¨ç½²ï¼Ÿ(y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "éƒ¨ç½²å–æ¶ˆ"
    exit 0
fi

# è®°å½•å¼€å§‹æ—¶é—´
START_TIME=$(date +%s)
echo -e "${GREEN}å¼€å§‹æ—¶é—´: $(date)${NC}\n"

# ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥å‰ç½®æ¡ä»¶
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}æ­¥éª¤ 1/6: æ£€æŸ¥å‰ç½®æ¡ä»¶${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
chmod +x 00-prerequisites.sh
./00-prerequisites.sh

if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ å‰ç½®æ¡ä»¶æ£€æŸ¥å¤±è´¥${NC}"
    exit 1
fi

# ç¬¬äºŒæ­¥ï¼šåˆ›å»ºé›†ç¾¤
echo -e "\n${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}æ­¥éª¤ 2/6: åˆ›å»º EKS é›†ç¾¤ (çº¦ 15-20 åˆ†é’Ÿ)${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
chmod +x 01-create-cluster.sh
./01-create-cluster.sh

if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ é›†ç¾¤åˆ›å»ºå¤±è´¥${NC}"
    exit 1
fi

# ç¬¬ä¸‰æ­¥ï¼šå®‰è£…æ’ä»¶
echo -e "\n${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}æ­¥éª¤ 3/6: å®‰è£… K8s æ’ä»¶${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
chmod +x 02-install-addons.sh
./02-install-addons.sh

if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ æ’ä»¶å®‰è£…å¤±è´¥${NC}"
    exit 1
fi

# ç¬¬å››æ­¥ï¼šé…ç½®å¯†é’¥
echo -e "\n${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}æ­¥éª¤ 4/6: é…ç½®ç¯å¢ƒå˜é‡å’Œå¯†é’¥${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
chmod +x 03-configure-secrets.sh
./03-configure-secrets.sh

if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ å¯†é’¥é…ç½®å¤±è´¥${NC}"
    exit 1
fi

# ç¬¬äº”æ­¥ï¼šéƒ¨ç½²åº”ç”¨
echo -e "\n${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}æ­¥éª¤ 5/6: éƒ¨ç½² Kortix åº”ç”¨${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
chmod +x 04-deploy-application.sh
./04-deploy-application.sh

if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ åº”ç”¨éƒ¨ç½²å¤±è´¥${NC}"
    exit 1
fi

# ç¬¬å…­æ­¥ï¼šè®¾ç½®ç›‘æ§
echo -e "\n${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}æ­¥éª¤ 6/6: é…ç½®ç›‘æ§ç³»ç»Ÿ${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
chmod +x 05-setup-monitoring.sh
./05-setup-monitoring.sh

if [ $? -ne 0 ]; then
    echo -e "${YELLOW}âš ï¸  ç›‘æ§ç³»ç»Ÿé…ç½®å¤±è´¥ï¼Œä½†åº”ç”¨éƒ¨ç½²æˆåŠŸ${NC}"
fi

# è®¡ç®—æ€»è€—æ—¶
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))
HOURS=$((DURATION / 3600))
MINUTES=$(((DURATION % 3600) / 60))
SECONDS=$((DURATION % 60))

# è·å–è®¿é—®ä¿¡æ¯
BACKEND_LB=$(kubectl get service backend-api-service -n kortix-backend -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "æ­£åœ¨åˆ›å»ºä¸­...")
GRAFANA_LB=$(kubectl get service kube-prometheus-stack-grafana -n monitoring -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "æ­£åœ¨åˆ›å»ºä¸­...")

# æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
echo -e "\n${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆï¼${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

echo -e "\n${PURPLE}ğŸ“Š éƒ¨ç½²æ‘˜è¦:${NC}"
echo "æ€»è€—æ—¶: ${HOURS}h ${MINUTES}m ${SECONDS}s"
echo "é›†ç¾¤åç§°: kortix-cluster"
echo "åŒºåŸŸ: ${AWS_DEFAULT_REGION:-us-west-2}"
echo "èŠ‚ç‚¹æ•°: 2 (å¯æ‰©å±•åˆ° 5)"

echo -e "\n${PURPLE}ğŸŒ è®¿é—®ä¿¡æ¯:${NC}"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ åç«¯ API                                                        â”‚"
echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
echo "â”‚ URL: http://$BACKEND_LB"
echo "â”‚ å¥åº·æ£€æŸ¥: http://$BACKEND_LB/health"
echo "â”‚ API æ–‡æ¡£: http://$BACKEND_LB/docs"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ ç›‘æ§ç³»ç»Ÿ                                                        â”‚"
echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
echo "â”‚ Grafana: http://$GRAFANA_LB"
echo "â”‚ ç”¨æˆ·å: admin"
echo "â”‚ å¯†ç : kortix-admin-2024"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

echo -e "\n${PURPLE}ğŸ“‹ åç»­æ­¥éª¤:${NC}"
echo "1. ç­‰å¾… LoadBalancer å®Œå…¨å°±ç»ª (2-5åˆ†é’Ÿ)"
echo "2. åœ¨ Vercel ä¸­é…ç½®å‰ç«¯ç¯å¢ƒå˜é‡:"
echo "   NEXT_PUBLIC_BACKEND_URL=http://$BACKEND_LB"
echo "3. è®¿é—® Grafana æŸ¥çœ‹ç›‘æ§æ•°æ®"
echo "4. æµ‹è¯• API ç«¯ç‚¹ç¡®ä¿æ­£å¸¸å·¥ä½œ"

echo -e "\n${PURPLE}ğŸ› ï¸  ç®¡ç†å‘½ä»¤:${NC}"
echo "# æŸ¥çœ‹æ‰€æœ‰ Pod çŠ¶æ€"
echo "kubectl get pods -n kortix-backend"
echo ""
echo "# æŸ¥çœ‹åº”ç”¨æ—¥å¿—"
echo "kubectl logs -f deployment/backend-api -n kortix-backend"
echo ""
echo "# æ‰©ç¼©å®¹"
echo "kubectl scale deployment backend-api --replicas=3 -n kortix-backend"
echo ""
echo "# åˆ é™¤æ•´ä¸ªéƒ¨ç½²"
echo "eksctl delete cluster --name kortix-cluster --region ${AWS_DEFAULT_REGION:-us-west-2}"

# ç”Ÿæˆå®Œæ•´çš„éƒ¨ç½²æŠ¥å‘Š
cat > deployment-summary.txt <<EOF
Kortix EKS éƒ¨ç½²æ‘˜è¦
==================
éƒ¨ç½²æ—¶é—´: $(date)
æ€»è€—æ—¶: ${HOURS}h ${MINUTES}m ${SECONDS}s

é›†ç¾¤ä¿¡æ¯:
- åç§°: kortix-cluster
- åŒºåŸŸ: ${AWS_DEFAULT_REGION:-us-west-2}
- èŠ‚ç‚¹ç±»å‹: t3.medium
- èŠ‚ç‚¹æ•°é‡: 2-5 (è‡ªåŠ¨ä¼¸ç¼©)

æœåŠ¡è®¿é—®:
- åç«¯ API: http://$BACKEND_LB
- å¥åº·æ£€æŸ¥: http://$BACKEND_LB/health
- API æ–‡æ¡£: http://$BACKEND_LB/docs
- Grafana: http://$GRAFANA_LB (admin/kortix-admin-2024)

å…³é”®ç»„ä»¶:
âœ… EKS é›†ç¾¤
âœ… Backend API (2 å‰¯æœ¬)
âœ… Worker (2 å‰¯æœ¬)
âœ… Redis (1 å‰¯æœ¬)
âœ… Prometheus/Grafana ç›‘æ§
âœ… è‡ªåŠ¨æ‰©ç¼©å®¹ (HPA)
âœ… LoadBalancer
âœ… æŒä¹…åŒ–å­˜å‚¨

ç®¡ç†å‘½ä»¤:
kubectl get pods -n kortix-backend
kubectl logs -f deployment/backend-api -n kortix-backend
kubectl scale deployment backend-api --replicas=3 -n kortix-backend

æ¸…ç†å‘½ä»¤:
eksctl delete cluster --name kortix-cluster --region ${AWS_DEFAULT_REGION:-us-west-2}
EOF

echo -e "\n${GREEN}ğŸ“„ å®Œæ•´éƒ¨ç½²ä¿¡æ¯å·²ä¿å­˜åˆ° deployment-summary.txt${NC}"
echo -e "${GREEN}ğŸŠ Kortix åç«¯å·²æˆåŠŸéƒ¨ç½²åˆ° AWS EKSï¼${NC}\n"